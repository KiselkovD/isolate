# Isolate

Простой проект, реализующий изолированный Linux контейнер с использованием пространств имён (namespaces), cgroups и виртуальных сетевых интерфейсов. Позволяет запускать процесс внутри изолированного окружения, примерно как Docker, с использованием минимальной Alpine Linux rootfs.

***

## Возможности

- Изоляция процесса с помощью:
  - user, PID, network, mount, UTS, IPC namespaces
- Ограничение ресурсов через cgroups (CPU, память, количество процессов)
- Создание виртуальной сети (veth) с назначением IP адресов
- Изоляция файловой системы с pivot_root и монтированием procfs
- Демонстрационная поддержка IPC namespace (очередь сообщений)
- Запуск команд в изолированном окружении

***

## Подробное описание возможностей проекта Isolate

### Изоляция процессов с помощью Linux namespaces

- **user namespace (CLONE_NEWUSER)**  
  Позволяет запускать процессы с раздельными UID и GID, обеспечивая безопасность через снижение привилегий внутри контейнера, сохраняя при этом права суперпользователя в хост-системе.

- **PID namespace (CLONE_NEWPID)**  
  Каждый контейнер имеет собственное пространство идентификаторов процессов, начиная с PID 1, что позволяет изолировать запущенные процессы от хоста и других контейнеров.

- **Network namespace (CLONE_NEWNET)**  
  Позволяет создать отдельное сетевое пространство с собственными сетевыми интерфейсами, маршрутами и правилами, полностью изолируя сетевые ресурсы контейнера от системы.

- **Mount namespace (CLONE_NEWNS)**  
  Изолирует точки монтирования файловых систем. Используется для монтирования внутреннего корневого каталога контейнера с помощью `pivot_root` без влияния на хост.

- **UTS namespace (CLONE_NEWUTS)**  
  Позволяет задать уникальное имя хоста и домена для контейнера, изолированное от системы.

- **IPC namespace (CLONE_NEWIPC)**  
  Обеспечивает изоляцию системных сообщений и очередей (например, System V IPC), что позволяет контейнерам не пересекаться в использовании IPC.

***

### Управление ресурсами с помощью cgroups v2

- **Ограничение CPU**  
  Через `cpu.max` задаётся квота процессорного времени (например, 20% CPU), чтобы контролировать загрузку хоста.

- **Ограничение памяти**  
  Через `memory.max` определяется максимально доступный объем оперативной памяти (например, 50 МБ).

- **Ограничение количества процессов**  
  Через `pids.max` устанавливается лимит на максимальное число процессов внутри контейнера, предотвращая fork-бомбы и чрезмерное потребление PID.

***

### Настройка сети с виртуальными Ethernet интерфейсами

- Создается пара виртуальных Ethernet интерфейсов (`veth` pair), соединяющая хост и контейнер.
- Один конец интерфейса остается в сетевом пространстве хоста, второй переносится в пространство контейнера.
- На интерфейсах назначаются IP-адреса и маски подсети, что позволяет контейнеру иметь собственное сетевое окружение.
- Настройка и управление интерфейсами реализованы через Netlink сокеты для гибкой конфигурации.

***

### Изоляция файловой системы и организация корневого окружения

- Используется `pivot_root` для переключения корневой файловой системы на подготовленный Alpine Linux rootfs.
- Монтируется `procfs` внутри контейнера для корректной работы процессов и системных вызовов.
- Обеспечивается изоляция точек монтирования, чтобы контейнер не мог видеть файловую систему хоста.

***

## Структура проекта

```
├── include/                Заголовочные файлы
│   ├── cgroup_control.h
│   ├── netns.h
│   └── util.h
├── src/                    Исходники
│   ├── isolate.c           Основной код запуска и изоляции
│   ├── netns.c             Работа с network namespace и veth
│   └── cgroup_control.c    Управление cgroups
├── rootfs/                 Минимальная корневая файловая система (Alpine Linux)
│   ├── bin
│   ├── etc
│   ├── proc
│   └── …                   (типичная структура Linux rootfs)
├── obj/                    Скомпилированные объектные файлы
├── isolate                 Скомпилированный исполняемый файл
├── Makefile                Правила сборки
└── LICENSE
```

***

## Сборка

Для сборки проекта требуется `gcc` и стандартные системные заголовки для работы с namespaces и cgroups.

Выполните:

```bash
make
```

В результате появится исполняемый файл `isolate`.

Для очистки артефактов сборки:

```bash
make clean
```

***

## Использование

Пример запуска команды внутри изолированного окружения:

```bash
sudo ./isolate /bin/sh
```

- Запускает оболочку `sh` внутри контейнера,
- Использует `rootfs` как корневую файловую систему,
- Настраивает изоляцию namespaces и ресурсы cgroups,
- Настраивает виртуальную сеть с двумя veth интерфейсами между хостом и контейнером.

Обязательно запускать с правами суперпользователя (sudo), так как управление namespaces, cgroups и сетью требует привилегий.

***

## Требования

- Linux с поддержкой namespaces и cgroups v2
- Права администратора (root)
- Минимальный rootfs (например, Alpine Linux) по пути `rootfs/`

***

## Как работает

1. Родительский процесс вызывает `clone()` с набором флагов для изоляции.
2. Создаются и настраиваются cgroups.
3. Создаются виртуальные сетевые интерфейсы (veth), добавляются в соответствующие network namespaces и настраиваются IP адреса.
4. Настраивается корневая файловая система с помощью `pivot_root` и монтируется procfs.
5. Дочерний процесс запускает заданную команду внутри изолированного окружения.
